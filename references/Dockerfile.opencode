FROM debian:trixie-slim

# Install system dependencies.
RUN apt-get update && \
    apt-get install -y \
        build-essential \
        git \
        git-delta \
        curl \
        ca-certificates \
        jq \
        bc \
        ripgrep \
        gh \
        python3 \
        rustup \
        nodejs \
        npm && \
    rm -rf /var/lib/apt/lists/*

# Create directory structure and set HOME.
# Make /home/user writable by any user since container runs with --user flag.
# Pre-create common directories that applications expect to write to.
ARG USERNAME
RUN mkdir -p /home/${USERNAME}/devel \
             /home/${USERNAME}/.local/bin \
             /home/${USERNAME}/.local/share \
             /home/${USERNAME}/.local/state \
             /home/${USERNAME}/.config && \
    chmod -R 777 /home/${USERNAME}
ENV HOME=/home/${USERNAME}
ENV PATH="${HOME}/.local/bin:${PATH}"

# Enable interoperability between Linux and MacOS for absolute symlinks
# pointing into the home folder.
RUN ln -s /home /Users && chmod 555 /Users

# Install Rust stable toolchain.
RUN rustup install stable && rustup default stable

# Install uv.
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV UV_PROJECT_ENVIRONMENT=jpenv-venv-container

# Accept build date argument to bust cache.
ARG BUILD_DATE
RUN echo "Build date: ${BUILD_DATE}"

# Install OpenCode globally.
RUN npm install -g opencode-ai && \
    npm cache clean --force

# Set working directory.
WORKDIR /home/${USERNAME}/devel

# Set entrypoint.
ENTRYPOINT ["opencode"]

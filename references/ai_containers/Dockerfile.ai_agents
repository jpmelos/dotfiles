FROM debian:trixie-slim AS base

# Install system dependencies.
RUN apt-get update && \
    apt-get install -y \
        build-essential \
        curl \
        ca-certificates \
        git \
        git-delta \
        jq \
        bc \
        ripgrep \
        gh \
        pre-commit \
        neovim \
        python3 \
        nodejs \
        npm && \
    rm -rf /var/lib/apt/lists/*

ARG USERNAME

# Create directory structure and set HOME.
# Make /home/user writable by any user since container runs with --user flag.
# Pre-create common directories that applications expect to write to.
RUN mkdir -p /home/${USERNAME}/devel \
             /home/${USERNAME}/.local/bin \
             /home/${USERNAME}/.local/share \
             /home/${USERNAME}/.local/state \
             /home/${USERNAME}/.config \
             /home/${USERNAME}/.npm \
             /home/${USERNAME}/.cache/pre-commit && \
    chmod -R 777 /home/${USERNAME}

ENV HOME=/home/${USERNAME}
ENV PATH="${HOME}/bin:${HOME}/.cargo/bin:${HOME}/.local/bin:${PATH}"
ENV EDITOR="vim"

ENV UV_PROJECT_ENVIRONMENT="jpenv-venv-container"
ENV UV_LINK_MODE="copy"

# Set working directory.
WORKDIR /home/${USERNAME}/devel

# Enable interoperability between Linux and MacOS for absolute symlinks
# pointing into the home folder.
RUN ln -s /home /Users && chmod 555 /Users

# Install Rust stable toolchain.
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o install_rust.sh && \
    bash install_rust.sh -y && \
    rustup install stable && \
    rustup default stable && \
    rm install_rust.sh

# Install uv.
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Install Docker.
RUN curl -sL https://download.docker.com/linux/ubuntu/dists/questing/pool/stable/arm64/docker-ce-cli_29.2.1-1~ubuntu.25.10~questing_arm64.deb -o docker-ce-cli.deb && \
    dpkg -i docker-ce-cli.deb && \
    rm docker-ce-cli.deb
RUN curl -sL https://download.docker.com/linux/ubuntu/dists/questing/pool/stable/arm64/docker-buildx-plugin_0.31.1-1~ubuntu.25.10~questing_arm64.deb -o docker-buildx-plugin.deb && \
    dpkg -i docker-buildx-plugin.deb && \
    rm docker-buildx-plugin.deb
RUN curl -sL https://download.docker.com/linux/ubuntu/dists/questing/pool/stable/arm64/docker-compose-plugin_5.0.2-1~ubuntu.25.10~questing_arm64.deb -o docker-compose-plugin.deb && \
    dpkg -i docker-compose-plugin.deb && \
    rm docker-compose-plugin.deb

# Accept build date argument to bust cache.
ARG BUILD_DATE
RUN echo "Build date: ${BUILD_DATE}"

# ============================================================================

FROM base AS claude

# Install Claude Code.
RUN curl -fsSL https://claude.ai/install.sh -o /root/claude-install.sh && \
    bash /root/claude-install.sh && \
    rm /root/claude-install.sh

ENTRYPOINT ["claude"]

# ============================================================================

FROM base AS opencode

# Install OpenCode.
RUN npm install -g opencode-ai && \
    npm cache clean --force

ENTRYPOINT ["opencode"]

FROM debian:trixie-slim AS base

ARG USERNAME
ARG BUILD_DATE

# Install system dependencies.
RUN apt-get update && \
    apt-get install -y \
        build-essential \
        git \
        git-delta \
        curl \
        ca-certificates \
        jq \
        bc \
        ripgrep \
        gh \
        pre-commit \
        vim \
        python3 \
        rustup \
        nodejs \
        npm && \
    rm -rf /var/lib/apt/lists/*

# Create directory structure and set HOME.
# Make /home/user writable by any user since container runs with --user flag.
# Pre-create common directories that applications expect to write to.
RUN mkdir -p /home/${USERNAME}/devel \
             /home/${USERNAME}/.local/bin \
             /home/${USERNAME}/.local/share \
             /home/${USERNAME}/.local/state \
             /home/${USERNAME}/.config \
             /home/${USERNAME}/.npm \
             /home/${USERNAME}/.cache/pre-commit && \
    chmod -R 777 /home/${USERNAME}

ENV HOME=/home/${USERNAME}
ENV PATH="${HOME}/.local/bin:${PATH}"
ENV EDITOR="vim"

ENV UV_PROJECT_ENVIRONMENT="jpenv-venv-container"
ENV UV_LINK_MODE="copy"

# Set working directory.
WORKDIR /home/${USERNAME}/devel

# Enable interoperability between Linux and MacOS for absolute symlinks
# pointing into the home folder.
RUN ln -s /home /Users && chmod 555 /Users

# Install Rust stable toolchain.
RUN rustup install stable && rustup default stable

# Install uv.
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Accept build date argument to bust cache.
RUN echo "Build date: ${BUILD_DATE}"

FROM base AS claude

# Install Claude Code.
RUN curl -fsSL https://claude.ai/install.sh -o /root/claude-install.sh && \
    bash /root/claude-install.sh && \
    rm /root/claude-install.sh

ENTRYPOINT ["claude"]

FROM base AS opencode

# Install OpenCode.
RUN npm install -g opencode-ai && \
    npm cache clean --force

ENTRYPOINT ["opencode"]

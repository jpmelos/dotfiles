#!/usr/bin/env bash
set -euo pipefail
trap 'echo "Exit status $? at line $LINENO from: $BASH_COMMAND"' ERR

#/ Send a Telegram notification, optionally running a command first.
#/
#/ Usage:
#/   tw <message> [command] [args...]
#/
#/ Example:
#/   tw "Running tests" npm test
#/   tw "Long operation" sleep 10
#/   tw "Just a notification"

# Check if message was provided.
if [ $# -lt 1 ]; then
    echo "Error: Message required" >&2
    echo "Usage: tw <message> [command] [args...]" >&2
    exit 1
fi

# Extract the message from the first argument.
USER_MESSAGE="$1"
shift

# Check if a command was provided.
HAS_COMMAND=false
if [ $# -gt 0 ]; then
    HAS_COMMAND=true
fi

# Fetch Telegram credentials from 1Password.
TELEGRAM_BOT_SECRET=$(
    op item get "Telegram Bot" \
        --vault "Private" --format json \
        | jq -r ".fields[0].value"
)
if [ -z "$TELEGRAM_BOT_SECRET" ] || [ "$TELEGRAM_BOT_SECRET" = "null" ]; then
    echo "Error: Failed to fetch Telegram Bot secret from 1Password" >&2
    exit 1
fi

TELEGRAM_BOT_TOKEN=$(
    toml get <(echo "$TELEGRAM_BOT_SECRET") . | jq -r ".telegram_bot.bot_token"
)
if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ "$TELEGRAM_BOT_TOKEN" = "null" ]; then
    echo "Error: Failed to parse telegram_bot.bot_id from secret" >&2
    exit 1
fi

TELEGRAM_CHAT_ID=$(
    toml get <(echo "$TELEGRAM_BOT_SECRET") . | jq -r ".telegram_bot.chat_id"
)
if [ -z "$TELEGRAM_CHAT_ID" ] || [ "$TELEGRAM_CHAT_ID" = "null" ]; then
    echo "Error: Failed to parse telegram_bot.channel_id from secret" >&2
    exit 1
fi

# Capture metadata.
HOSTNAME=$(hostname)
PWD_PATH=$(pwd)

# Execute the command if provided.
if [ "$HAS_COMMAND" = true ]; then
    START_TIME=$(date +%s)
    COMMAND_STRING="$*"

    set +e
    "$@"
    EXIT_CODE=$?
    set -e

    # Calculate duration.
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
else
    EXIT_CODE=0
fi

# Format notification message.
if [ "$HAS_COMMAND" = true ]; then
    # Format duration as human-readable.
    if [ $DURATION -lt 60 ]; then
        DURATION_STR="${DURATION}s"
    elif [ $DURATION -lt 3600 ]; then
        MINUTES=$((DURATION / 60))
        SECONDS=$((DURATION % 60))
        DURATION_STR="${MINUTES}m ${SECONDS}s"
    else
        HOURS=$((DURATION / 3600))
        MINUTES=$(((DURATION % 3600) / 60))
        SECONDS=$((DURATION % 60))
        DURATION_STR="${HOURS}h ${MINUTES}m ${SECONDS}s"
    fi

    # Format message with command results.
    if [ $EXIT_CODE -eq 0 ]; then
        STATUS_EMOJI="✅"
        STATUS_TEXT="Task finished successfully!"
    else
        STATUS_EMOJI="❌"
        STATUS_TEXT="Task failed with exit code $EXIT_CODE"
    fi

    MESSAGE="$STATUS_EMOJI $STATUS_TEXT

$USER_MESSAGE

Command: $COMMAND_STRING
Duration: $DURATION_STR
Location: $HOSTNAME:$PWD_PATH"
else
    # Format message without command.
    MESSAGE="$USER_MESSAGE

Location: $HOSTNAME:$PWD_PATH"
fi

# Send Telegram notification.
TELEGRAM_API_URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"

CURL_OUTPUT=$(curl -s -X POST "$TELEGRAM_API_URL" \
    -d "chat_id=$TELEGRAM_CHAT_ID" \
    --data-urlencode "text=$MESSAGE" \
    2>&1)

CURL_EXIT=$?

if [ $CURL_EXIT -ne 0 ]; then
    echo "Warning: Failed to send Telegram notification (curl exit code: $CURL_EXIT)" >&2
    echo "Curl output: $CURL_OUTPUT" >&2
elif ! jq -e '.ok' <<< "$CURL_OUTPUT" > /dev/null 2>&1; then
    echo "Warning: Telegram API returned error: $CURL_OUTPUT" >&2
fi

# Exit with the same status as the original command.
exit $EXIT_CODE
